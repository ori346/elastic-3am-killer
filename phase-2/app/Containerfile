FROM python:3.12-slim-bookworm

COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install OpenShift CLI
RUN apt-get update && \
    apt-get install -y curl && \
    curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz | \
    tar -xz -C /usr/local/bin/ && \
    chmod +x /usr/local/bin/oc && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY . /app

WORKDIR /app

RUN uv sync --locked --no-dev

# Create cache directory and set OpenShift permissions
RUN mkdir -p /app/.cache && \
    chgrp -R 0 /app && \
    chmod -R g+rwX /app

# Set UV cache to writable location
ENV UV_CACHE_DIR=/app/.cache/uv

CMD ["sh", "-c", "uv run uvicorn main:app --host ${APP_HOST:-0.0.0.0} --port ${APP_PORT:-5001} --reload"]
