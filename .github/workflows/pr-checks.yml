name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  pre-commit-checks:
    runs-on: ubuntu-latest
    name: Pre-commit Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8

      - name: Get changed Python files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' | grep -v '.venv/' || true)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- '*.py' | grep -v '.venv/' || true)
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Run black on changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "${{ steps.changed-files.outputs.files }}" | xargs -r black --check --diff
        continue-on-error: false

      - name: Run flake8 on changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "${{ steps.changed-files.outputs.files }}" | xargs -r flake8 --extend-ignore=E501,W503
        continue-on-error: false

  helm-lint:
    runs-on: ubuntu-latest
    name: Helm Lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Get changed Helm charts
        id: changed-charts
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_HELM_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '**/helm/**' || true)
          else
            CHANGED_HELM_FILES=$(git diff --name-only HEAD~1 HEAD -- '**/helm/**' || true)
          fi

          # Extract unique chart directories from changed files
          CHARTS=""
          if [ -n "$CHANGED_HELM_FILES" ]; then
            while IFS= read -r file; do
              if [[ "$file" =~ helm/([^/]+) ]]; then
                CHART_DIR=$(echo "$file" | grep -oP '.*?/helm/[^/]+' | head -1)
                if [ -f "$CHART_DIR/Chart.yaml" ]; then
                  CHARTS="${CHARTS}${CHART_DIR}"$'\n'
                fi
              fi
            done <<< "$CHANGED_HELM_FILES"
            CHARTS=$(echo "$CHARTS" | sort -u)
          fi

          echo "charts<<EOF" >> $GITHUB_OUTPUT
          echo "$CHARTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Lint changed Helm charts
        if: steps.changed-charts.outputs.charts != ''
        run: |
          echo "${{ steps.changed-charts.outputs.charts }}" | while read chart; do
            if [ -n "$chart" ]; then
              echo "Linting $chart"
              helm lint "$chart" || exit 1
            fi
          done
